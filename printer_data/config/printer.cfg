[include .dynamicmacros.cfg]
#   _____             __ _                       _   _                
#  / ____|           / _(_)                     | | (_)                
# | |     ___  _ __ | |_ _  __ _ _   _ _ __ __ _| |_ _  ___  _ __  ___ 
# | |    / _ \| '_ \|  _| |/ _` | | | | '__/ _` | __| |/ _ \| '_ \/ __|
# | |___| (_) | | | | | | | (_| | |_| | | | (_| | |_| | (_) | | | \__ \
#  \_____\___/|_| |_|_| |_|\__, |\__,_|_|  \__,_|\__|_|\___/|_| |_|___/
#                           __/ |                                      
#                          |___/    
#
# Klipper Configurations - Flsun Super Racer
# Version 3.0
#
# Guislain Cyril


########################################
# Firmware Settings
########################################

# MKS Robin Nano V3.0/V3.1

# When running "make menuconfig"
#
# [*] Enable extra low-level configuration options
#     Micro-controller Architecture (STMicroelectronics STM32)  --->
#     Processor model (STM32F407)  --->
#     Bootloader offset (48KiB bootloader (MKS Robin Nano V3))  --->
#     Clock Reference (8 MHz crystal)  --->
#     Communication interface (USB (on PA11/PA12))  --->
#     USB ids  --->
# ()  GPIO pins to set at micro-controller startup (NEW)
#
# Note that the "make flash" command does not work with this board.
# Rename the file out/klipper.bin to Robin_nano_v3.bin, copy it an microSD 
# card, insert it in the printer and restart it.


########################################
# Editable Settings
########################################

# Notes: Some settings can be enabled or disabled by removing or adding the '#' symbol
#
# PID (pid_Kp, pid_Ki, pid_Kd) --> [extruder] and [heater_bed] sections
# E-Steps Extruder (rotation_distance) --> [extruder] section --> <rotation_distance> = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>
# Pressure Advance (pressure_advance) --> [extruder] section -- See: https://www.klipper3d.org/Pressure_Advance.html
# Firmware Retraction --> [firmware_retraction] section -- Requires "Klipper Settings Plugin" for Cura -- See: https://github.com/jjgraphix/KlipperSettingsPlugin
# ADXL345 function for resonance testing --> Enable/Disable [include adxl345_pico.cfg] or [include adxl345_fysetc.cfg] -- Configuration in [input_shaper] section -- See: https://www.klipper3d.org/Measuring_Resonances.html
# NeoPixels macros --> Enable/Disable [include neopixels.cfg]
# Timelapse function --> Enable/Disable [include timelapse.cfg]


########################################
# Included Files
########################################

[include macros.cfg]
#[include filaments.cfg]
#[include sample-bigtreetech-lis2dw-v1.0.cfg]
#[include timelapse.cfg]  #Enable if you want to use Timelapse
#[include neopixels.cfg]  #Enable if you want to use some Neopixels macros
[dynamicmacros]
configs: dynamic.cfg


########################################
# Printer Settings
########################################

[printer]
kinematics: delta
max_velocity: 300
max_accel: 4500
minimum_cruise_ratio: 0.5
#max_accel_to_decel: 2000
square_corner_velocity: 10    #â–‘5 #25
max_z_velocity: 300
max_z_accel: 1500
minimum_z_position: -25
print_radius: 132
#delta_radius: 151.7


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_a]
step_pin: PF9
dir_pin: PD7
enable_pin: !PD6
microsteps: 16
rotation_distance: 40
endstop_pin: ^PB5
homing_speed: 40
second_homing_speed: 5
homing_retract_dist: 5.0
homing_retract_speed: 10
#angle: 210
#position_endstop: 336
#arm_length = 315

[tmc2209 stepper_a]
uart_pin: PF10
run_current: 1.138
hold_current: 0.5
#diag_pin:
stealthchop_threshold: 999999


########################################
# Y Stepper Motor & Driver Settings
########################################

[stepper_b]
step_pin: PD3
dir_pin: PD2
enable_pin: !PD5
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC1
#angle: 330

[tmc2209 stepper_b]
uart_pin: PD4
run_current: 1.138
hold_current: 0.5
#diag_pin:
stealthchop_threshold: 999999


########################################
# Z Stepper Motor & Driver Settings
########################################

[stepper_c]
step_pin: PA15
dir_pin: PF8
enable_pin: !PC9
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
#angle: 90

[tmc2209 stepper_c]
uart_pin: PC8
run_current: 1.138
hold_current: 0.5
#diag_pin:
stealthchop_threshold: 999999


########################################
# Extruder & Driver Settings
########################################

[extruder]
step_pin: PC7
dir_pin: PC6
enable_pin: !PD9
microsteps: 16
rotation_distance: 5.57     #7.805
full_steps_per_rotation: 200
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: PE11
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA3
min_temp: -5
max_temp: 275
max_extrude_only_velocity: 120
max_extrude_only_accel: 800
#max_extrude_cross_section:
#   Maximum area (in mm^2) of an extrusion cross section (eg,
#   extrusion width multiplied by layer height). This setting prevents
#   excessive amounts of extrusion during relatively small XY moves.
#   If a move requests an extrusion rate that would exceed this value
#   it will cause an error to be returned. The default is: 4.0 *
#   nozzle_diameter^2
#instantaneous_corner_velocity: 1.000
#   The maximum instantaneous velocity change (in mm/s) of the
#   extruder during the junction of two moves. The default is 1mm/s.
#max_extrude_only_distance: 50.0
#   Maximum length (in mm of raw filament) that a retraction or
#   extrude-only move may have. If a retraction or extrude-only move
#   requests a distance greater than this value it will cause an error
#   to be returned. The default is 50mm.
#max_delta: 2.0
#   On 'watermark' controlled heaters this is the number of degrees in
#   Celsius above the target temperature before disabling the heater
#   as well as the number of degrees below the target before
#   re-enabling the heater. The default is 2 degrees Celsius.
max_extrude_cross_section: 110 
max_extrude_only_distance: 1100
pressure_advance: 0.043
#pressure_advance_smooth_time: 
#control = pid
#pid_kp = 18.240
#pid_ki = 0.558
#pid_kd = 149.109

[tmc2209 extruder]
uart_pin: PD8
run_current: 1.1
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Extra
########################################

#[extruder2]
#step_pin: PC7
#dir_pin: !PC6
#enable_pin: !PD9
#microsteps: 16
#rotation_distance: 7.805
#full_steps_per_rotation: 200
#nozzle_diameter: 0.4
#filament_diameter: 1.750
#heater_pin: PE11
#sensor_type: EPCOS 100K B57560G104F
#sensor_pin: PA3

#[tmc2209 extruder1]
#uart_pin: PB11
#run_current: 0.600
#diag_pin:

#sensor_type:MAX31865
#sensor_pin: PA4
#spi_bus: spi1
#rtd_nominal_r: 100
#rtd_reference_r: 430
#rtd_num_of_wires: 2

#[temperature_sensor TH2]
#sensor_type: Generic 3950
#sensor_pin: PA1

#[temperature_sensor TH3]
#sensor_type: Generic 3950
#sensor_pin: PA0


########################################
# Bed Settings
########################################

[heater_bed]
heater_pin: PB3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PB2
min_temp: -5
max_temp: 115
#control = pid
#pid_kp = 71.041
#pid_ki = 1.422
#pid_kd = 887.123


########################################
# Filament Sensor Settings
########################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode: PAUSE
insert_gcode:
event_delay: 3.0
pause_delay: 0.5
switch_pin: PF5 #PE6


##################################################
# Fan
##################################################
[fan]
pin: PD15  #PD13    
#   Output pin controlling the fan. This parameter must be provided.
#max_power: 1.0
#   The maximum power (expressed as a value from 0.0 to 1.0) that the
#   pin may be set to. The value 1.0 allows the pin to be set fully
#   enabled for extended periods, while a value of 0.5 would allow the
#   pin to be enabled for no more than half the time. This setting may
#   be used to limit the total power output (over extended periods) to
#   the fan. If this value is less than 1.0 then fan speed requests
#   will be scaled between zero and max_power (for example, if
#   max_power is .9 and a fan speed of 80% is requested then the fan
#   power will be set to 72%). The default is 1.0.
#shutdown_speed: 0
#   The desired fan speed (expressed as a value from 0.0 to 1.0) if
#   the micro-controller software enters an error state. The default
#   is 0.
#cycle_time: 0.010
#   The amount of time (in seconds) for each PWM power cycle to the
#   fan. It is recommended this be 10 milliseconds or greater when
#   using software based PWM. The default is 0.010 seconds.
#hardware_pwm: False
#   Enable this to use hardware PWM instead of software PWM. Most fans
#   do not work well with hardware PWM, so it is not recommended to
#   enable this unless there is an electrical requirement to switch at
#   very high speeds. When using hardware PWM the actual cycle time is
#   constrained by the implementation and may be significantly
#   different than the requested cycle_time. The default is False.
#kick_start_time: 0.100
#   Time (in seconds) to run the fan at full speed when either first
#   enabling or increasing it by more than 50% (helps get the fan
#   spinning). The default is 0.100 seconds.
#off_below: 0.0
#   The minimum input speed which will power the fan (expressed as a
#   value from 0.0 to 1.0). When a speed lower than off_below is
#   requested the fan will instead be turned off. This setting may be
#   used to prevent fan stalls and to ensure kick starts are
#   effective. The default is 0.0.
#
#   This setting should be recalibrated whenever max_power is adjusted.
#   To calibrate this setting, start with off_below set to 0.0 and the
#   fan spinning. Gradually lower the fan speed to determine the lowest
#   input speed which reliably drives the fan without stalls. Set
#   off_below to the duty cycle corresponding to this value (for
#   example, 12% -> 0.12) or slightly higher.
#tachometer_pin:
#   Tachometer input pin for monitoring fan speed. A pullup is generally
#   required. This parameter is optional.
#tachometer_ppr: 2
#   When tachometer_pin is specified, this is the number of pulses per
#   revolution of the tachometer signal. For a BLDC fan this is
#   normally half the number of poles. The default is 2.
#tachometer_poll_interval: 0.0015
#   When tachometer_pin is specified, this is the polling period of the
#   tachometer pin, in seconds. The default is 0.0015, which is fast
#   enough for fans below 10000 RPM at 2 PPR. This must be smaller than
#   30/(tachometer_ppr*rpm), with some margin, where rpm is the
#   maximum speed (in RPM) of the fan.
#enable_pin:
#   Optional pin to enable power to the fan. This can be useful for fans
#   with dedicated PWM inputs. Some of these fans stay on even at 0% PWM
#   input. In such a case, the PWM pin can be used normally, and e.g. a
#   ground-switched FET(standard fan pin) can be used to control power to
#   the fan.

[heater_fan HotEnd_Fan]
pin: PE13
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.
#heater: extruder
#   Name of the config section defining the heater that this fan is
#   associated with. If a comma separated list of heater names is
#   provided here, then the fan will be enabled when any of the given
#   heaters are enabled. The default is "extruder".
heater_temp: 60.0
#   A temperature (in Celsius) that the heater must drop below before
#   the fan is disabled. The default is 50 Celsius.
fan_speed: 0.9
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when its associated heater is enabled. The default
#   is 1.0

[controller_fan TMC_Driver_Fan]
pin: PD14
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.
fan_speed: 0.8
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver is active.
#   The default is 1.0
idle_timeout: 30
#   The amount of time (in seconds) after a stepper driver or heater
#   was active and the fan should be kept running. The default
#   is 30 seconds.
#idle_speed:
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver was active and
#   before the idle_timeout is reached. The default is fan_speed.
#heater:
#stepper:
#   Name of the config section defining the heater/stepper that this fan
#   is associated with. If a comma separated list of heater/stepper names
#   is provided here, then the fan will be enabled when any of the given
#   heaters/steppers are enabled. The default heater is "extruder", the
#   default stepper is all of them.


#[heater_fan fan2]
#pin: PD13

#[heater_fan fan3]
#pin: PD12

#[heater_fan 4W_FAN0]
#pin: PE9
#tachometer_pin: PD11
#tachometer_ppr: 1

#[heater_fan 4W_FAN1]
#pin: PE14
#tachometer_pin: PD10
#tachometer_ppr: 1



########################################
# Filament Sensor Settings
########################################

[delayed_gcode bed_mesh_init]
initial_duration: .01
gcode:
    BED_MESH_PROFILE LOAD=default
    
[probe]
pin: !PF4
x_offset: 0
y_offset: 0
#z_offset: 14.550
speed: 10
lift_speed: 30
samples: 3
samples_result: average
sample_retract_dist: 4
samples_tolerance: 0.015
samples_tolerance_retries: 5


########################################
# Delta Calibration & Mesh Settings
########################################

[delta_calibrate]
radius: 130
horizontal_move_z: 30
speed: 100

[bed_mesh]
speed: 60
horizontal_move_z: 30 #5
mesh_radius: 127.5
mesh_origin: 0,0
round_probe_count: 9 #9 for extreme conditions most likely over kill 9/10. first layer height should be min 0.3 for volcanos or above max "deviation" 
mesh_pps: 2,2  
algorithm: bicubic
bicubic_tension: 0.1
move_check_distance: 3
#split_delta_z: 0.025
#fade_start: 1
#fade_end: 30
#zero_reference_position: 0,0
# Note relative_reference index is now depreciated in facvor of zero_refence_position. left as "legacy" for older klipper versions. 
#relative_reference_index: 6 # Mesh values: 6=5 points 24 = 9 point Its better to use  less points in most cases unless dealing with extreamly  uneven surfaces eg bubbled stickers , chunky powercoat etc 


########################################
# Temperature Controls
########################################

[verify_heater extruder]
max_error: 160
heating_gain: 1

[verify_heater heater_bed]
max_error: 120
heating_gain: 1


########################################
# Firmware Retraction Settings
########################################

[firmware_retraction]
retract_length: 2
retract_speed: 35
unretract_extra_length: 0.01
unretract_speed: 35


########################################
# Input Shaper Settings
########################################

[input_shaper]
# Asse X
#shaper_type_x    = zv
#shaper_freq_x    = 46.2    ; Hz (valore emerso dal test)
damping_ratio_x  = 0.1
# Asse Y
#shaper_type_y    = zv
#shaper_freq_y    = 50.0    ; Hz (valore emerso dal test)
damping_ratio_y  = 0.1


########################################
# G-Code Macros & Events
########################################

[idle_timeout]
timeout: 1800   #TIME BEFORE PRINTER TURNS OFF HEATERS AND STEPPERS MAX IDLE TIME 5MINS 

[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_arcs]
resolution: 0.1

[pause_resume]

[display_status]

[respond]

[exclude_object]

[virtual_sdcard]
path: ~/printer_data/gcodes

#[endstop_phase stepper_a]
#endstop_align_zero: false

#[endstop_phase stepper_b]
#endstop_align_zero: false

#[endstop_phase stepper_c]
#endstop_align_zero: false 

########################################
# Maintain
########################################

[maintain]
interval: 60 # optional, time (in seconds) between checking if maintenance needs to be done (default is 60)

# Lubricate XY rods
[maintain xyrods]
label: XY smooth rods
trigger: print_time
threshold: 500
message: Lubricate XY smooth rods

# Replace air filter
[maintain airfilter]
label: Air filter
trigger: print_time
threshold: 200
message: Replace HEPA and charcoal filters

# Extruder maintenance
[maintain extruder]
label: Extruder maintenance
trigger: filament
threshold: 1000
message: Clean extruder gears and tighten extruder bolts

########################################
# Led
########################################

#[mcu host]
#serial: /tmp/klipper_host_mcu

# Case Light
[output_pin caselight]
pin: PD13
pwm: True
value: 0.0
shutdown_value: 0.0
cycle_time: 0.010     # es. 10 ms per ciclo (se usi software PWM)
hardware_pwm: False



# Example1: A led strip controlled by the GPIO20 on the RPi
#[output_pin caselight]
#pin: host:gpio24
# You can also write the pin in extended form by specifying
# the reference gpiochip.
#pin: host:gpiochip0/gpio20

#[gcode_macro TOGGLE_CASELIGHT]
#gcode:
  #SET_PIN PIN=caselight VALUE={(not printer['output_pin caselight'].value)|int}

########################################
# MCU Settings
########################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_260008000D504B4633373520-if00
restart_method: command

[temperature_sensor Raspberry]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor Motherboard]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#pid_kp = 75.517


[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC13, EXP1_3=PC3, EXP1_5=PB1, EXP1_7=PC5, EXP1_9=<GND>,
    EXP1_2=PF3,  EXP1_4=PC2, EXP1_6=PB0, EXP1_8=PC4, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE7, EXP2_5=PE8, EXP2_7=PE10,  EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PF7, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<NC>
    
    
    ########################################
    # LED Settings
    ########################################
    
    #[neopixel NeoPixels]
    #pin: PB2
    #chain_count: 34
    #color_order: GRB
    #initial_RED: 1.0
    #initial_GREEN: 1.0
    #initial_BLUE: 1.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 16.388
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 31.2
#*# shaper_type_y = 2hump_ei
#*# shaper_freq_y = 39.0
#*#
#*# [stepper_a]
#*# angle = 209.719382
#*# arm_length = 315.000000
#*# position_endstop = 332.414923
#*#
#*# [stepper_b]
#*# arm_length = 315.000000
#*# position_endstop = 333.254880
#*# angle = 329.815898
#*#
#*# [stepper_c]
#*# arm_length = 315.000000
#*# position_endstop = 331.927494
#*# angle = 90.000000
#*#
#*# [printer]
#*# delta_radius = 151.776590
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.000730, -0.000730, -0.000730, -0.000730, -0.000730, -0.000730, -0.000730, -0.000730, -0.000730
#*# 	  0.106856, 0.106856, 0.106856, 0.122283, 0.117904, 0.085590, 0.062334, 0.062334, 0.062334
#*# 	  0.136095, 0.136095, 0.171942, 0.173754, 0.162142, 0.174882, 0.142554, 0.130459, 0.130459
#*# 	  0.191239, 0.191239, 0.191929, 0.204734, 0.205341, 0.195200, 0.174666, 0.157090, 0.157090
#*# 	  0.147709, 0.160502, 0.188718, 0.209292, 0.173590, 0.220950, 0.223497, 0.177438, 0.107088
#*# 	  0.184518, 0.184518, 0.194534, 0.188509, 0.203850, 0.211677, 0.195572, 0.174850, 0.174850
#*# 	  0.178469, 0.178469, 0.147622, 0.170098, 0.179027, 0.194037, 0.203140, 0.143037, 0.143037
#*# 	  0.183077, 0.183077, 0.183077, 0.161129, 0.173009, 0.200144, 0.172498, 0.172498, 0.172498
#*# 	  0.213713, 0.213713, 0.213713, 0.213713, 0.213713, 0.213713, 0.213713, 0.213713, 0.213713
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = -127.48
#*# max_x = 127.48
#*# min_y = -127.48
#*# max_y = 127.48000000000002
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.615
#*# pid_ki = 1.617
#*# pid_kd = 65.710
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.035
#*# pid_ki = 2.654
#*# pid_kd = 516.396
#*#
#*# [delta_calibrate]
#*# height0 = 16.388
#*# height0_pos = 25281.333,25351.333,25241.333
#*# height1 = 16.388
#*# height1_pos = 30903.000,31020.000,22226.000
#*# height2 = 16.388
#*# height2_pos = 24681.000,34294.000,24661.000
#*# height3 = 16.388
#*# height3_pos = 22380.333,30036.333,29942.000
#*# height4 = 16.388
#*# height4_pos = 24509.000,24555.000,31267.000
#*# height5 = 16.388
#*# height5_pos = 29159.000,22608.000,29099.000
#*# height6 = 16.388
#*# height6_pos = 32656.000,24655.000,24534.000
